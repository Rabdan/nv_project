nv_simple/n8n-data/workflows/auto_generate_posts.json#L1-999
{
  "name": "Auto Generate Posts",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "generate-posts",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        250,
        150
      ],
      "webhookId": "generate-posts-manual"
    },
    {
      "parameters": {
        "url": "={BACKEND_URL}/api/strategies?filter={{ encodeURIComponent(JSON.stringify({ month: $json.body.month })) }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $json.headers && $json.headers.authorization ? $json.headers.authorization : '' }}"
            },
            {
              "name": "x-api-key",
              "value": "{X-API-KEY}"
            }
          ]
        },
        "options": {}
      },
      "id": "get-strategy-by-month",
      "name": "Get Strategy by Month",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        450,
        150
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.items.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-empty",
      "name": "If Empty",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        650,
        150
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ JSON.stringify({ error: 'Strategy not found for month' }) }",
        "options": {
          "responseCode": 404
        }
      },
      "id": "respond-not-found",
      "name": "Respond Not Found",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        850,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "// Extract the strategy from API response\nconst strategy = $json.items && $json.items[0] ? $json.items[0] : null;\nreturn { strategy };"
      },
      "id": "extract-strategy",
      "name": "Extract Strategy",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        850,
        250
      ]
    },
    {
      "parameters": {
        "jsCode": "// Compute missing scheduled posts for the whole month\nconst strategy = $('Extract Strategy').item.json.strategy;\nif (!strategy) return { postsToGenerate: [], strategy: null };\nconst schedule = strategy.schedule || {};\nconst existingPosts = strategy.posts || [];\nconst monthStr = strategy.month; // expecting YYYY-MM\nconst [year, monthNum] = monthStr.split('-').map(Number);\nconst daysInMonth = new Date(year, monthNum, 0).getDate();\nconst dayMap = { 'Sun': 0, 'Mon': 1, 'Tue': 2, 'Wed': 3, 'Thu': 4, 'Fri': 5, 'Sat': 6 };\nconst postsToGenerate = [];\n\nfor (let d = 1; d <= daysInMonth; d++) {\n  const date = new Date(year, monthNum - 1, d);\n  const dayOfWeek = date.getDay();\n  Object.keys(schedule).forEach(platformKey => {\n    const cfg = schedule[platformKey];\n    if (!cfg || !cfg.days) return;\n    const scheduledDays = cfg.days.map(x => dayMap[x]);\n    if (!scheduledDays.includes(dayOfWeek)) return;\n    const [hours, minutes] = (cfg.time || '09:00').split(':').map(Number);\n    const sched = new Date(date);\n    sched.setHours(hours, minutes, 0, 0);\n    const iso = sched.toISOString();\n    const platformName = platformKey.charAt(0).toUpperCase() + platformKey.slice(1);\n    const exists = existingPosts.some(p => p.platform === platformName && new Date(p.scheduledDate).getTime() === sched.getTime());\n    if (!exists) {\n      postsToGenerate.push({ platform: platformName, scheduledDate: iso, platformKey });\n    }\n  });\n}\n\nreturn { strategy: strategy, postsToGenerate };"
      },
      "id": "check-posts-needed",
      "name": "Check Posts Needed",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1050,
        250
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.postsToGenerate.length }}",
              "value2": 0
            }
          ]
        }
      },
      "id": "if-posts-needed",
      "name": "If Posts Needed",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1250,
        250
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'No posts to generate', strategy: $json.strategy }) }}",
        "options": {}
      },
      "id": "respond-no-posts",
      "name": "Respond No Posts",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1450,
        200
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "split-posts",
      "name": "Split Posts to Generate",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1450,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Prepare prompt for content generation\nconst strategy = $('Check Posts Needed').item.json.strategy || {};\nconst post = $input.item.json;\nconst prompt = `Create engaging social media content for ${post.platform}.\n\nStrategy Theme: ${strategy.theme}\nContent Pillars: ${JSON.stringify(strategy.pillars)}\nTopics: ${(strategy.topics||[]).join(', ')}\n\nPlatform: ${post.platform}\nScheduled Date: ${post.scheduledDate}\n\nGenerate a compelling post that aligns with our content strategy. Include relevant hashtags and call-to-action.`;\nreturn { prompt: prompt, platform: post.platform, scheduledDate: post.scheduledDate, strategyId: strategy._id || strategy.id || strategyId };"
      },
      "id": "prepare-prompt",
      "name": "Prepare Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1650,
        300
      ]
    },
    {
      "parameters": {
        "model": "gpt-4",
        "messages": {
          "values": [
            {
              "content": "={{ $json.prompt }}"
            }
          ]
        },
        "options": {}
      },
      "id": "generate-content",
      "name": "Generate Content (OpenAI)",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1,
      "position": [
        1850,
        300
      ],
      "credentials": {
        "openAiApi": {
          "id": "OpenAI Key",
          "name": "OpenAI Key"
        }
      }
    },
    {
      "parameters": {
        "model": "dall-e-3",
        "prompt": "={{ 'Create a professional social media image for: ' + $('Prepare Prompt').item.json.prompt.substring(0, 200) }}",
        "options": {
          "size": "1024x1024"
        }
      },
      "id": "generate-image",
      "name": "Generate Image (DALL-E)",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [
        2050,
        300
      ],
      "credentials": {
        "openAiApi": {
          "id": "OpenAI Key",
          "name": "OpenAI Key"
        }
      }
    },
    {
      "parameters": {
        "url": "{BACKEND_URL}/api/uploads",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "{X-API-KEY}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "image",
              "value": "={{ $json.data && $json.data[0] ? $json.data[0].url : '' }}"
            },
            {
              "name": "filename",
              "value": "={{ $('Prepare Prompt').item.json.strategyId + '_' + Date.now() + '.png' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "save-image",
      "name": "Save Image",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2250,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Prepare post data from generated content and saved image\nconst gen = $('Generate Content (OpenAI)').item.json;\nlet content = '';\nif (gen.message && gen.message.content) content = gen.message.content;\nelse if (gen.choices && gen.choices[0] && gen.choices[0].message) content = gen.choices[0].message.content || '';\nelse if (gen.choices && gen.choices[0] && gen.choices[0].text) content = gen.choices[0].text || '';\n\nconst imageResp = $json;\nconst imageUrl = imageResp && (imageResp.url || imageResp.path || (imageResp.items && imageResp.items[0] && imageResp.items[0].url)) ? (imageResp.url || imageResp.path || imageResp.items[0].url) : ($json.data && $json.data[0] ? $json.data[0].url : '');\nconst prep = $('Prepare Prompt').item.json;\nreturn { platform: prep.platform, scheduledDate: prep.scheduledDate, content: content, image: imageUrl, status: 'pending', generatedAt: new Date().toISOString() };"
      },
      "id": "prepare-post-data",
      "name": "Prepare Post Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2450,
        300
      ]
    },
    {
      "parameters": {
        "url": "={BACKEND_URL}/api/strategies/{{ $('Prepare Prompt').item.json.strategyId }}",
        "method": "GET",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "{X-API-KEY}"
            }
          ]
        },
        "options": {}
      },
      "id": "get-strategy",
      "name": "Get Strategy",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2650,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Add new post to the strategy and return updated strategy object\nconst strategy = $json;\nconst newPost = $('Prepare Post Data').item.json;\nif (!strategy.posts) strategy.posts = [];\nstrategy.posts.push(newPost);\nreturn strategy;"
      },
      "id": "add-post",
      "name": "Add Post to Strategy",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2850,
        300
      ]
    },
    {
      "parameters": {
        "url": "={BACKEND_URL}/api/strategies/{{ $('Prepare Prompt').item.json.strategyId }}",
        "method": "PUT",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "{X-API-KEY}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "update-strategy",
      "name": "Update Strategy",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        3050,
        300
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "respond",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        3250,
        300
      ]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Get Strategy by Month",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Strategy by Month": {
      "main": [
        [
          {
            "node": "If Empty",
            "type": "main",
            "index": 0
          },
          {
            "node": "Extract Strategy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Empty": {
      "main": [
        [
          {
            "node": "Respond Not Found",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Strategy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Strategy": {
      "main": [
        [
          {
            "node": "Check Posts Needed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Posts Needed": {
      "main": [
        [
          {
            "node": "If Posts Needed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Posts Needed": {
      "main": [
        [
          {
            "node": "Respond No Posts",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Split Posts to Generate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Posts to Generate": {
      "main": [
        [
          {
            "node": "Prepare Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Prompt": {
      "main": [
        [
          {
            "node": "Generate Content (OpenAI)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Content (OpenAI)": {
      "main": [
        [
          {
            "node": "Generate Image (DALL-E)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Image (DALL-E)": {
      "main": [
        [
          {
            "node": "Save Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Image": {
      "main": [
        [
          {
            "node": "Prepare Post Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Post Data": {
      "main": [
        [
          {
            "node": "Get Strategy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Strategy": {
      "main": [
        [
          {
            "node": "Add Post to Strategy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Post to Strategy": {
      "main": [
        [
          {
            "node": "Update Strategy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Strategy": {
      "main": [
        [
          {
            "node": "Split Posts to Generate",
            "type": "main",
            "index": 0
          },
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {},
  "versionId": "1"
}
